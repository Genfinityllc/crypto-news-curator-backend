const fs = require('fs');
const path = require('path');
const axios = require('axios');
require('dotenv').config({ path: path.join(__dirname, '../.env') });

const OUTPUT_DIR = path.join(__dirname, '../style-examples');
const LOGO_SYMBOL = 'HBAR';
const WAVESPEED_API_KEY = process.env.WAVESPEED_API_KEY;

const GENERATIONS = [
  {
    // Coins with lime (#dbff03) pop accents
    oldFile: '20_navy_purple_coins_minimal.png',
    newFile: '20_navy_lime_accent_coins.png',
    prompt: `deep navy blue void fading to rich black, dramatic dark lighting with lime green (#dbff03) accent highlights, photorealistic 3D environment, single prominent ${LOGO_SYMBOL} cryptocurrency logo as the hero subject rendered in crystal glass with silver chrome core and lime green (#dbff03) edge glow, soft cinematic lighting with elegant refractions, scattered glass coins featuring the ${LOGO_SYMBOL} logo with bright lime green (#dbff03) glowing edges and accents, the coins have vibrant lime colored rim light creating strong pop against the dark navy background, clean minimal composition, the logo crafted from premium materials with volumetric lighting, cinematic composition, 8k resolution, ultra-detailed, Octane render, Cinema 4D quality, premium 3D CGI product render, no text`
  },
  {
    // Torn construction paper revealing logo with newspaper clippings
    oldFile: '08_global_glass_sphere.png',
    newFile: '08_torn_paper_news_clippings.png',
    prompt: `dark purple and black torn construction paper layers with rough ripped edges creating a hole in the center, dramatic ambient occlusion shadows around the torn edges, photorealistic 3D environment, the ${LOGO_SYMBOL} cryptocurrency logo revealed through the torn paper opening as the hero subject, the ${LOGO_SYMBOL} symbol rendered in polished chrome with purple light reflections emerging from behind the torn layers, floating 3D newspaper clipping shapes and paper fragments with financial headlines scattered around, vintage newspaper texture elements with crypto and ${LOGO_SYMBOL} network themed words visible, paper craft aesthetic with realistic paper texture and shadows, the logo crafted from premium materials with volumetric lighting, cinematic composition, 8k resolution, ultra-detailed, Octane render, Cinema 4D quality, premium 3D CGI product render, no globe`
  }
];

async function generateImage(item) {
  console.log(`\nüé® Generating: ${item.newFile}`);

  try {
    if (item.oldFile) {
      const oldPath = path.join(OUTPUT_DIR, item.oldFile);
      if (fs.existsSync(oldPath)) {
        fs.unlinkSync(oldPath);
        console.log(`   üóëÔ∏è Deleted: ${item.oldFile}`);
      }
    }

    const logoResponse = await axios.get(
      `https://crypto-news-curator-backend-production.up.railway.app/api/cover-generator/logo-preview/${LOGO_SYMBOL}`,
      { responseType: 'arraybuffer', timeout: 15000 }
    );
    const base64Logo = Buffer.from(logoResponse.data).toString('base64');
    const logoUrl = `data:image/png;base64,${base64Logo}`;

    const response = await axios.post('https://api.wavespeed.ai/api/v3/google/nano-banana-pro/edit', {
      enable_base64_output: false,
      enable_sync_mode: false,
      images: [logoUrl],
      output_format: "png",
      prompt: item.prompt,
      resolution: "2k",
      aspect_ratio: "16:9"
    }, {
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${WAVESPEED_API_KEY}`
      },
      timeout: 120000
    });

    const requestId = response.data.data?.id || response.data.id;
    console.log(`   üìã Job ID: ${requestId}`);

    let result = null;
    for (let attempt = 0; attempt < 60; attempt++) {
      await new Promise(r => setTimeout(r, 2000));
      const poll = await axios.get(`https://api.wavespeed.ai/api/v3/predictions/${requestId}/result`, {
        headers: { 'Authorization': `Bearer ${WAVESPEED_API_KEY}` },
        timeout: 15000
      });
      if (poll.data.data?.status === 'completed') { result = poll.data.data; break; }
      if (poll.data.data?.status === 'failed') throw new Error(`Job failed: ${poll.data.data.error || 'Unknown'}`);
      if (attempt % 5 === 0) console.log(`   ‚è≥ Waiting... (${attempt * 2}s)`);
    }

    if (!result?.outputs?.[0]) throw new Error('Timeout');

    const img = await axios.get(result.outputs[0], { responseType: 'arraybuffer', timeout: 30000 });
    fs.writeFileSync(path.join(OUTPUT_DIR, item.newFile), Buffer.from(img.data));
    console.log(`   ‚úÖ Saved: ${item.newFile}`);
    return true;
  } catch (e) {
    console.log(`   ‚ùå Failed: ${e.message}`);
    return false;
  }
}

async function main() {
  console.log('üöÄ Fixing Coins & Replacing Globe\n');
  for (const item of GENERATIONS) {
    await generateImage(item);
    await new Promise(r => setTimeout(r, 1000));
  }
  console.log('\n‚úÖ Done!');
}

main().catch(console.error);
